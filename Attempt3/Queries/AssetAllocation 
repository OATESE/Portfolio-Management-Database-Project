SELECT 
    a.Asset_Type, 
    SUM(pos.Quantity * pr.Price_Close) AS Total_Value
FROM 
    [PRACTICE3].[Clients] c
JOIN 
    [PRACTICE3].[Portfolios] p ON c.Client_ID = p.Client_ID
JOIN 
    [PRACTICE3].[Positions] pos ON p.Portfolio_ID = pos.Portfolio_ID
JOIN 
    [PRACTICE3].[Assets] a ON pos.Asset_Symbol = a.AssetSymbol
JOIN 
    [PRACTICE3].[Prices] pr ON a.AssetSymbol = pr.Asset_Symbol AND pr.Date = '2023-02-28' -- Use the most recent date for valuation
WHERE 
    c.Client_Name = 'John Doe'
GROUP BY 
    a.Asset_Type;


---

SELECT 
    a.Asset_Type, 
    SUM(pos.Quantity * pr.Price_Close) AS Total_Value,
    SUM(pos.Quantity * pr.Price_Close) / Total.Total_Value * 100 AS Percentage
FROM 
    [PRACTICE3].[Clients] c
JOIN 
    [PRACTICE3].[Portfolios] p ON c.Client_ID = p.Client_ID
JOIN 
    [PRACTICE3].[Positions] pos ON p.Portfolio_ID = pos.Portfolio_ID
JOIN 
    [PRACTICE3].[Assets] a ON pos.Asset_Symbol = a.AssetSymbol
JOIN 
    [PRACTICE3].[Prices] pr ON a.AssetSymbol = pr.Asset_Symbol AND pr.Date = '2023-02-28', -- Use the most recent date for valuation
    -- Subquery to calculate total portfolio value
    (SELECT 
        SUM(pos.Quantity * pr.Price_Close) AS Total_Value
     FROM 
        [PRACTICE3].[Clients] c
     JOIN 
        [PRACTICE3].[Portfolios] p ON c.Client_ID = p.Client_ID
     JOIN 
        [PRACTICE3].[Positions] pos ON p.Portfolio_ID = pos.Portfolio_ID
     JOIN 
        [PRACTICE3].[Assets] a ON pos.Asset_Symbol = a.AssetSymbol
     JOIN 
        [PRACTICE3].[Prices] pr ON a.AssetSymbol = pr.Asset_Symbol AND pr.Date = '2023-02-28'
     WHERE 
        c.Client_Name = 'John Doe'
    ) AS Total
WHERE 
    c.Client_Name = 'John Doe'
GROUP BY 
    a.Asset_Type,
    Total.Total_Value;

